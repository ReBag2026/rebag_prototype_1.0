import { useEffect, useRef, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

export default function ReBagPrototype() {
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const [timeLeft, setTimeLeft] = useState(8);
  const [photoTaken, setPhotoTaken] = useState(false);
  const [photoURL, setPhotoURL] = useState(null);

  useEffect(() => {
    navigator.mediaDevices
      .getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => {
        if (videoRef.current) videoRef.current.srcObject = stream;
      });
  }, []);

  useEffect(() => {
    if (timeLeft <= 0 || photoTaken) return;
    const timer = setInterval(() => setTimeLeft((t) => t - 1), 1000);
    return () => clearInterval(timer);
  }, [timeLeft, photoTaken]);

  const takePhoto = () => {
    const video = videoRef.current;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    const url = canvas.toDataURL("image/jpeg");
    setPhotoURL(url);
    setPhotoTaken(true);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
      <Card className="max-w-sm w-full">
        <CardContent className="p-4 space-y-4">
          <h1 className="text-xl font-bold text-center">reBag Scan</h1>
          {!photoTaken && (
            <>
              <p className="text-center text-sm">Mache jetzt ein Foto deiner reBag mit Inhalt</p>
              <p className="text-center font-bold">{timeLeft}s</p>
              <video ref={videoRef} autoPlay playsInline className="rounded-xl w-full" />
              <Button onClick={takePhoto} className="w-full">Foto aufnehmen</Button>
            </>
          )}
          {photoTaken && (
            <>
              <img src={photoURL} className="rounded-xl w-full" />
              <p className="text-center text-green-600 font-semibold">âœ” Nutzung erkannt (Demo)</p>
              <p className="text-center">+1 Punkt gutgeschrieben</p>
            </>
          )}
          <canvas ref={canvasRef} className="hidden" />
        </CardContent>
      </Card>
    </div>
  );
}
